const i="d265053b-d8ee-47d1-b4b8-b14ac07b00cd";const h=chrome.identity.getRedirectURL(),l=async()=>{const t=`https://app.hubspot.com/oauth/authorize?client_id=${i}&redirect_uri=${encodeURIComponent(h)}&scope=contacts%20oauth`;try{const e=await chrome.identity.launchWebAuthFlow({url:t,interactive:!0}),r=new URL(e).searchParams.get("code");if(!r)throw new Error("No code received");return u(r)}catch(e){throw console.error("Auth error:",e),e}},u=async t=>{const e=await fetch("https://your-vercel-app.vercel.app/api/token-exchange",{method:"POST",headers:{"X-Extension-Id":chrome.runtime.id,"Content-Type":"application/json"},body:JSON.stringify({code:t})});if(!e.ok){const o=await e.text();throw console.error("Token exchange failed:",o),new Error(`Token exchange failed: ${e.status}`)}return e.json()},f=async t=>(await fetch("https://api.hubapi.com/account-info/v3/details",{headers:{Authorization:`Bearer ${t}`}})).json(),p=async t=>{const e=await fetch("https://api.hubapi.com/oauth/v1/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",client_id:i,client_secret:null,refresh_token:t})});if(!e.ok){const r=await e.text();throw console.error("Token refresh failed:",r),new Error(`Token refresh failed: ${e.status}`)}const o=await e.json();return console.log("Token refresh response:",o),o},d=t=>{if(!t)return!0;try{if(t.includes(".")){const o=JSON.parse(atob(t.split(".")[1])).exp*1e3;return Date.now()>=o}return!0}catch(e){return console.error("Error checking token expiry:",e),!0}},c=async t=>{if(!t||!t.refreshToken)throw new Error("Invalid account or missing refresh token");try{if(d(t.accessToken)){console.log("Token expired, refreshing...");const e=await p(t.refreshToken),s=((await chrome.storage.sync.get("hubspotAccounts")).hubspotAccounts||[]).map(n=>n.hubId===t.hubId?{...n,accessToken:e.access_token,refreshToken:e.refresh_token,tokenTimestamp:Date.now()}:n);return await chrome.storage.sync.set({hubspotAccounts:s}),e.access_token}return t.accessToken}catch(e){throw console.error("Token refresh error:",e),new Error("Failed to refresh token. Please re-authenticate.")}},w=async(t,e)=>{try{const o=await c(e),r=await fetch(`https://api.hubapi.com/content/api/v4/custom_widgets/${t}`,{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});if(!r.ok){const s=await r.text();if(console.error("Module info fetch failed:",s),r.status===401){console.log("Unauthorized, attempting token refresh...");const n=await c({...e,accessToken:null}),a=await fetch(`https://api.hubapi.com/content/api/v4/custom_widgets/${t}`,{headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"}});if(!a.ok)throw new Error(`Failed to fetch module info: ${a.status}`);return a.json()}throw new Error(`Failed to fetch module info: ${r.status}`)}return r.json()}catch(o){throw console.error("Module info error:",o),o}};export{w as a,f as g,l as i};
